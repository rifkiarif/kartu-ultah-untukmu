<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birthday Photo Booth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Plus+Jakarta+Sans:wght@400;600&display=swap');
        
        :root {
            --bg-color: #7d746d;
            --strip-bg: #f2ece8;
            --accent: #4a3f35;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-color);
            background-image: url("https://www.transparenttextures.com/patterns/paper.png");
            min-height: 100vh;
            color: #fff;
            transition: background-color 0.5s ease;
        }

        .serif { font-family: 'Playfair Display', serif; }

        .viewfinder-box {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 3/4;
            border: 8px solid white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            background: #000;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .flash {
            animation: flashEffect 0.4s ease-out;
        }
        @keyframes flashEffect {
            0% { background: white; opacity: 1; }
            100% { background: transparent; opacity: 0; }
        }

        .strip-preview-container {
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: fit-content;
            margin: 0 auto;
        }

        #strip-preview-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 2px;
        }

        .theme-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .theme-card.active {
            border-color: #fff;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        textarea { resize: none; }
        
        .btn-action {
            transition: all 0.2s ease;
        }
        .btn-action:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold serif mb-2">Birthday Photo Booth</h1>
            <p class="text-gray-200 italic">Pilih tema bingkai favoritmu dan abadikan momen!</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-12 items-start justify-center">
            
            <!-- Konfigurasi & Kamera -->
            <div class="w-full lg:w-2/5 flex flex-col gap-6">
                
                <!-- Pilih Tema -->
                <div class="bg-black/20 p-6 rounded-2xl backdrop-blur-sm">
                    <h3 class="text-sm font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fas fa-palette"></i> Pilih Tema Bingkai
                    </h3>
                    <div class="grid grid-cols-4 gap-3">
                        <div onclick="setTheme('classic', this)" class="theme-card active rounded-lg p-2 text-center" data-theme="classic">
                            <div class="w-full aspect-square bg-[#ffffff] border border-gray-300 rounded mb-1"></div>
                            <span class="text-[10px] font-bold uppercase">Classic</span>
                        </div>
                        <div onclick="setTheme('vintage', this)" class="theme-card rounded-lg p-2 text-center" data-theme="vintage">
                            <div class="w-full aspect-square bg-[#f2ece8] border border-[#d3c5b8] rounded mb-1"></div>
                            <span class="text-[10px] font-bold uppercase">Vintage</span>
                        </div>
                        <div onclick="setTheme('midnight', this)" class="theme-card rounded-lg p-2 text-center" data-theme="midnight">
                            <div class="w-full aspect-square bg-[#1a1a1a] rounded mb-1"></div>
                            <span class="text-[10px] font-bold uppercase">Dark</span>
                        </div>
                        <div onclick="setTheme('rose', this)" class="theme-card rounded-lg p-2 text-center" data-theme="rose">
                            <div class="w-full aspect-square bg-[#fff0f3] border border-[#ffccd5] rounded mb-1"></div>
                            <span class="text-[10px] font-bold uppercase">Rose</span>
                        </div>
                    </div>
                </div>

                <!-- Kamera -->
                <div class="flex flex-col items-center gap-4">
                    <div class="viewfinder-box">
                        <div id="flash-overlay" class="absolute inset-0 z-40 pointer-events-none"></div>
                        <div id="countdown" class="absolute inset-0 flex items-center justify-center text-white text-9xl font-black z-50 hidden drop-shadow-2xl">3</div>
                        <video id="video" autoplay playsinline></video>
                        <div class="absolute bottom-4 left-0 right-0 text-center z-20">
                            <span id="capture-status" class="bg-black/50 px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest hidden">Bersiap...</span>
                        </div>
                    </div>

                    <div class="flex flex-col gap-4 w-full max-w-[400px]">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="birthday-name" placeholder="Nama Ultah" value="Febiana Baruroh Amalia Fahmi" class="bg-white/10 border border-white/20 p-3 rounded-lg text-white placeholder:text-white/50 focus:bg-white/20 outline-none">
                            <input type="text" id="birthday-age" placeholder="Umur (Misal: 25)" value="26" class="bg-white/10 border border-white/20 p-3 rounded-lg text-white placeholder:text-white/50 focus:bg-white/20 outline-none">
                        </div>
                        <input type="text" id="date-text" placeholder="Tanggal Acara" value="9 Februari 2026" class="bg-white/10 border border-white/20 p-3 rounded-lg text-white placeholder:text-white/50 focus:bg-white/20 outline-none">
                        <textarea id="wish-text" rows="2" placeholder="Tulis doa & harapan..." class="bg-white/10 border border-white/20 p-3 rounded-lg text-white placeholder:text-white/50 focus:bg-white/20 outline-none">Selamat ulang tahun yaaaa.Semoga diberkahi hidupnya. Disehatkan dan dilancarkan segala urusan dilapangkan hati dan diluaskan sabarnya, dipanjangkan dan diberkahi umurnya, dan semoga semua impianmu tercapai!ü´∂üèªü§≤üèª</textarea>
                        
                        <button id="start-btn" class="bg-white text-gray-900 hover:bg-gray-100 py-4 rounded-xl font-bold text-lg shadow-xl transition-all flex items-center justify-center gap-3 active:scale-95">
                            <i class="fas fa-camera"></i> AMBIL 3 FOTO
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Hasil -->
            <div id="result-area" class="w-full lg:w-1/3 opacity-50 transition-opacity duration-500 sticky top-8">
                <div class="text-center mb-4 uppercase text-xs font-bold tracking-[0.2em] text-white/70">Pratinjau Strip (HD)</div>
                <div class="strip-preview-container">
                    <canvas id="strip-preview-canvas"></canvas>
                </div>
                <div id="action-buttons" class="mt-6 flex flex-col gap-3 hidden">
                    <button id="share-btn" class="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 btn-action">
                        <i class="fas fa-share-nodes"></i> BAGIKAN KE STORY / WA
                    </button>
                    <button id="download-btn" class="bg-white text-gray-800 px-8 py-4 rounded-xl font-bold shadow-lg hover:bg-gray-100 transition flex items-center justify-center gap-2 btn-action">
                        <i class="fas fa-download"></i> SIMPAN KUALITAS HD
                    </button>
                </div>
                <p id="share-note" class="text-[10px] text-center mt-3 text-white/50 italic hidden">*Kualitas HD memerlukan waktu proses sedikit lebih lama.</p>
            </div>
        </div>
    </div>

    <!-- Modal Pesan -->
    <div id="message-modal" class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center hidden p-4">
        <div class="bg-white rounded-2xl p-6 text-gray-900 max-w-sm w-full text-center">
            <div id="modal-icon" class="text-4xl mb-4 text-blue-600"></div>
            <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
            <p id="modal-text" class="text-gray-600 mb-6"></p>
            <button onclick="closeModal()" class="bg-gray-900 text-white w-full py-3 rounded-xl font-bold">Tutup</button>
        </div>
    </div>

    <!-- Kanvas Internal untuk Render HD (2400x3600 untuk hasil super tajam) -->
    <canvas id="internal-canvas" class="hidden" width="2400" height="3600"></canvas>

    <script>
        const video = document.getElementById('video');
        const startBtn = document.getElementById('start-btn');
        const downloadBtn = document.getElementById('download-btn');
        const shareBtn = document.getElementById('share-btn');
        const actionButtons = document.getElementById('action-buttons');
        const shareNote = document.getElementById('share-note');
        const countdownEl = document.getElementById('countdown');
        const flashEl = document.getElementById('flash-overlay');
        const statusEl = document.getElementById('capture-status');
        const previewCanvas = document.getElementById('strip-preview-canvas');
        const internalCanvas = document.getElementById('internal-canvas');
        
        let capturedImages = [];
        const TOTAL_PHOTOS = 3;

        const themes = {
            classic: { bg: '#ffffff', text: '#333333', accent: '#666666', bodyBg: '#4a4a4a' },
            vintage: { bg: '#f2ece8', text: '#4a3f35', accent: '#7d746d', bodyBg: '#7d746d' },
            midnight: { bg: '#1a1a1a', text: '#ffffff', accent: '#d4af37', bodyBg: '#0f172a' },
            rose: { bg: '#fff0f3', text: '#590d22', accent: '#ff4d6d', bodyBg: '#800f2f' }
        };

        let currentTheme = 'classic';

        function setTheme(themeName, el) {
            currentTheme = themeName;
            document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.body.style.backgroundColor = themes[themeName].bodyBg;
            if (capturedImages.length > 0) renderFinalStrip();
        }

        function showMessage(title, text, iconClass = "fa-circle-info") {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-text').innerText = text;
            document.getElementById('modal-icon').innerHTML = `<i class="fas ${iconClass}"></i>`;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('message-modal').classList.add('hidden');
        }

        async function initCamera() {
            try {
                // Mencoba mendapatkan resolusi HD dari kamera
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user', 
                        width: { ideal: 1920 }, 
                        height: { ideal: 1080 } 
                    } 
                });
                video.srcObject = stream;
            } catch (err) {
                showMessage("Kamera Error", "Gagal mengakses kamera. Pastikan izin kamera sudah diberikan.", "fa-video-slash");
            }
        }

        startBtn.addEventListener('click', async () => {
            capturedImages = [];
            startBtn.disabled = true;
            startBtn.innerHTML = '<span class="loading-dots">RENDERING HD</span>';
            document.getElementById('result-area').style.opacity = "0.5";
            actionButtons.classList.add('hidden');
            shareNote.classList.add('hidden');

            for (let i = 0; i < TOTAL_PHOTOS; i++) {
                statusEl.innerText = `FOTO ${i+1} DARI ${TOTAL_PHOTOS}`;
                statusEl.classList.remove('hidden');
                await runCountdown(3);
                flashEl.classList.add('flash');
                setTimeout(() => flashEl.classList.remove('flash'), 400);
                capturePhotoHD();
                await sleep(800);
            }

            await renderFinalStrip();
            statusEl.classList.add('hidden');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-camera"></i> AMBIL LAGI (HD)';
            document.getElementById('result-area').style.opacity = "1";
            actionButtons.classList.remove('hidden');
            shareNote.classList.remove('hidden');
        });

        function runCountdown(sec) {
            return new Promise(resolve => {
                let count = sec;
                countdownEl.innerText = count;
                countdownEl.classList.remove('hidden');
                const timer = setInterval(() => {
                    count--;
                    if (count <= 0) {
                        clearInterval(timer);
                        countdownEl.classList.add('hidden');
                        resolve();
                    } else {
                        countdownEl.innerText = count;
                    }
                }, 1000);
            });
        }

        function capturePhotoHD() {
            const tempCanvas = document.createElement('canvas');
            // Gunakan resolusi tinggi untuk setiap frame foto (misal 1200x900)
            const targetWidth = 1200;
            const targetHeight = 900;
            tempCanvas.width = targetWidth;
            tempCanvas.height = targetHeight;
            const ctx = tempCanvas.getContext('2d');
            
            // Pengaturan kualitas render
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            const videoW = video.videoWidth;
            const videoH = video.videoHeight;
            const videoAspect = videoW / videoH;
            const targetAspect = targetWidth / targetHeight;
            
            let sourceX = 0, sourceY = 0, sourceWidth = videoW, sourceHeight = videoH;
            if (videoAspect > targetAspect) {
                sourceWidth = videoH * targetAspect;
                sourceX = (videoW - sourceWidth) / 2;
            } else {
                sourceHeight = videoW / targetAspect;
                sourceY = (videoH - sourceHeight) / 2;
            }
            
            ctx.translate(targetWidth, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, targetWidth, targetHeight);
            
            // Simpan sebagai PNG atau JPEG kualitas tinggi
            capturedImages.push(tempCanvas.toDataURL('image/png'));
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxHeight) {
            const words = text.split(' ');
            let line = '';
            let lines = [];
            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                if (ctx.measureText(testLine).width > maxWidth && n > 0) {
                    lines.push(line);
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line);
            if (lines.length * lineHeight > maxHeight && ctx.currentFontSize > 20) {
                ctx.currentFontSize -= 2;
                ctx.font = `italic ${ctx.currentFontSize}px "Plus Jakarta Sans"`;
                return wrapText(ctx, text, x, y, maxWidth, ctx.currentFontSize + 12, maxHeight);
            }
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], x, y + (i * lineHeight));
            }
        }

        function drawResponsiveText(ctx, text, x, y, maxWidth, baseSize, fontFace) {
            let fontSize = baseSize;
            ctx.font = `${fontSize}px ${fontFace}`;
            while (ctx.measureText(text).width > maxWidth && fontSize > 20) {
                fontSize -= 2;
                ctx.font = `${fontSize}px ${fontFace}`;
            }
            ctx.fillText(text, x, y);
        }

        function getOrdinal(n) {
            let s = ["th", "st", "nd", "rd"],
                v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function drawAestheticHeart(ctx, x, y, width, color) {
            ctx.save();
            ctx.beginPath();
            const topCurveHeight = width * 0.3;
            ctx.moveTo(x, y + topCurveHeight);
            ctx.bezierCurveTo(x, y, x - width / 2, y, x - width / 2, y + topCurveHeight);
            ctx.bezierCurveTo(x - width / 2, y + (width + topCurveHeight) / 2, x, y + (width + topCurveHeight) / 2, x, y + width);
            ctx.bezierCurveTo(x, y + (width + topCurveHeight) / 2, x + width / 2, y + (width + topCurveHeight) / 2, x + width / 2, y + topCurveHeight);
            ctx.bezierCurveTo(x + width / 2, y, x, y, x, y + topCurveHeight);
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
            ctx.restore();
        }

        async function renderFinalStrip() {
            const ctx = internalCanvas.getContext('2d');
            const w = internalCanvas.width;
            const h = internalCanvas.height;
            const theme = themes[currentTheme];
            
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            ctx.fillStyle = theme.bodyBg;
            ctx.fillRect(0, 0, w, h);
            
            // Render dua strip berdampingan
            const stripWidth = (w / 2) - 60;
            await drawStrip(ctx, 40, 40, stripWidth);
            await drawStrip(ctx, w/2 + 20, 40, stripWidth);
            
            // Update preview dengan resolusi layar yang disesuaikan
            const pCtx = previewCanvas.getContext('2d');
            previewCanvas.width = 800; // Lebar standar preview
            previewCanvas.height = (h / w) * 800;
            pCtx.imageSmoothingEnabled = true;
            pCtx.imageSmoothingQuality = 'high';
            pCtx.drawImage(internalCanvas, 0, 0, previewCanvas.width, previewCanvas.height);
        }

        async function drawStrip(ctx, startX, startY, width) {
            const theme = themes[currentTheme];
            const stripHeight = internalCanvas.height - 80;
            const imgWidth = width - 80;
            const imgHeight = imgWidth * 0.75;
            const gap = 40;
            const cornerRadius = 30;
            const centerX = startX + width/2;

            // Bingkai Utama
            ctx.fillStyle = theme.bg;
            roundRect(ctx, startX, startY, width, stripHeight, cornerRadius);
            ctx.fill();

            // Header Teks
            ctx.fillStyle = theme.text;
            ctx.font = 'bold 44px "Plus Jakarta Sans"';
            ctx.textAlign = 'center';
            ctx.fillText('‚ú® SPECIAL MOMENTS ‚ú®', centerX, startY + 90);

            // Render 3 Foto
            for (let i = 0; i < capturedImages.length; i++) {
                const img = await loadImage(capturedImages[i]);
                const yPos = startY + 150 + (i * (imgHeight + gap));
                ctx.drawImage(img, startX + 40, yPos, imgWidth, imgHeight);
            }

            // Bagian Bawah (Footer)
            const footerY = startY + 150 + (3 * (imgHeight + gap)) + 20;
            const name = document.getElementById('birthday-name').value || "Constance";
            const ageInput = document.getElementById('birthday-age').value || "25";
            const dateStr = document.getElementById('date-text').value || "9 May 2024";
            const wishStr = document.getElementById('wish-text').value || "";

            let ageDisplay = ageInput;
            if (!isNaN(ageInput) && ageInput.trim() !== "") {
                ageDisplay = getOrdinal(parseInt(ageInput));
            }

            // Hati Estetis
            drawAestheticHeart(ctx, centerX, footerY + 30, 160, theme.accent);

            ctx.fillStyle = theme.text;
            ctx.font = '56px "Plus Jakarta Sans"';
            ctx.fillText("Happy Birthday", centerX, footerY + 280);

            ctx.font = 'bold 96px "Playfair Display"';
            drawResponsiveText(ctx, name, centerX, footerY + 390, width - 80, 96, '"Playfair Display"');
            
            ctx.font = 'italic 64px "Playfair Display"';
            drawResponsiveText(ctx, `${ageDisplay} Birthday`, centerX, footerY + 480, width - 80, 64, '"Playfair Display"');

            ctx.font = '40px "Plus Jakarta Sans"';
            ctx.fillStyle = theme.accent;
            ctx.fillText(dateStr, centerX, footerY + 570);

            if (wishStr) {
                const initialFontSize = 36;
                ctx.currentFontSize = initialFontSize;
                ctx.font = `italic ${initialFontSize}px "Plus Jakarta Sans"`;
                ctx.fillStyle = theme.text;
                const availableHeight = (startY + stripHeight - 50) - (footerY + 650);
                wrapText(ctx, `"${wishStr}"`, centerX, footerY + 650, width - 160, ctx.currentFontSize + 12, availableHeight);
            }
        }

        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        function loadImage(src) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.src = src;
            });
        }
        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        // Fitur Berbagi HD
        shareBtn.addEventListener('click', async () => {
            try {
                // Konversi canvas HD ke blob (kualitas 1.0)
                const dataUrl = internalCanvas.toDataURL('image/png', 1.0);
                const response = await fetch(dataUrl);
                const blob = await response.blob();
                const file = new File([blob], `HD-Birthday-Strip-${Date.now()}.png`, { type: 'image/png' });

                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Photo Strip HD',
                        text: 'Momen ulang tahun spesial dalam kualitas HD!'
                    });
                } else {
                    showMessage("Berbagi Manual", "Browser tidak mendukung fitur bagi file. Hasil HD sudah tersimpan di memori sementara, silakan download.", "fa-triangle-exclamation");
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Error sharing:', err);
                    showMessage("Gagal Berbagi", "Terjadi kesalahan saat memproses gambar HD.");
                }
            }
        });

        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `HD-Photo-Strip-${Date.now()}.png`;
            // Pastikan download menggunakan kualitas tertinggi
            link.href = internalCanvas.toDataURL('image/png', 1.0);
            link.click();
        });

        window.onload = initCamera;
    </script>
</body>
</html>